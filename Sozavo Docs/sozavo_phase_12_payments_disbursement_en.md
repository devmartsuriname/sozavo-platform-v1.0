# SoZaVo Central Social Services Platform – Phase 12 Plan (Payments & Disbursement Integration)

> **Status:** Implementation Blueprint – Phase 12 (Post-MVP Expansion)  
> **Prepared for:** Devmart Suriname – SoZaVo Platform  
> **Scope:** Payment authorization, batch disbursement, banking integrations, payment auditing, finance workflows  
> **Related Docs:** Technical Architecture v2, Workflow Blueprint v2, Eligibility Engine, Reporting Engine, Build Instructions Phases 1–11

---

# 1. Purpose of Phase 12
Phase 12 introduces the **financial execution layer** of the SoZaVo system.

This enables:
- Generating monthly or ad-hoc **disbursement batches**
- Approving payments for eligible beneficiaries
- Exporting bank-ready transfer files
- Validating bank feedback after execution
- Logging all payment activity for audits

This module is essential for scaling SoZaVo into a complete **end‑to‑end social benefit delivery system**.

---

# 2. Design Principles

1. **Finance-Grade Auditability**  
   Every payment must be traceable from eligibility → approval → disbursement → bank confirmation.

2. **No Direct Bank Access From UI**  
   Payments flow through secure batch exports, not live API calls (v1).

3. **Four-Eyes Approval** (optional depending on policy)  
   Payment batches require two authorized officers.

4. **Immutable Payment Records**  
   Once a payment is approved, it cannot be deleted – only reversed with explicit action.

5. **RLS Enforcement**  
   Only finance officers and admins may view or manage payments.

---

# 3. New Tables Introduced in Phase 12

## 3.1 `payment_batches`
Represents a processing cycle (monthly or ad-hoc).

Fields:
- `id` (PK)
- `batch_name`
- `service_type_id`
- `period_from`
- `period_to`
- `status` (enum: `draft`, `pending_approval`, `approved`, `exported`, `sent_to_bank`, `completed`, `rejected`)
- `created_by_user_id`
- `approved_by_user_id` (nullable)
- `created_at`
- `updated_at`

---

## 3.2 `payment_items`
One record per citizen receiving payment.

Fields:
- `id`
- `batch_id` (FK → payment_batches.id)
- `citizen_id`
- `case_id`
- `amount`
- `currency` (default SRD)
- `bank_name`
- `bank_account_number`
- `status` (enum: `pending`, `approved`, `rejected`, `paid`, `failed`)
- `bank_reference` (nullable)
- `created_at`

---

## 3.3 `payment_audit_logs`
Full trace of operations.

Fields:
- `id`
- `event_type` (enum: `batch_created`, `batch_approved`, `item_added`, `item_updated`, `export_generated`, `bank_feedback_uploaded`)
- `actor_user_id`
- `batch_id`
- `item_id` (nullable)
- `meta` (JSONB)
- `created_at`

---

# 4. Payment Eligibility Criteria (Technical)

A payment may be generated only when:
- The case is **approved**
- No outstanding document requests
- Eligibility evaluation is **valid and recent**
- The case is active in the selected payment period

The `paymentGeneratorEngine` enforces this.

---

# 5. Payment Generator Engine

New module:
```
src/integrations/engines/paymentGeneratorEngine.ts
```

### Responsibilities:
- Collect all eligible approved cases
- Fetch bank details from citizen profile
- Compute payment amount per service type
- Reject cases missing required bank info
- Populate `payment_items` for the batch

### Example Logic:
- General Assistance → fixed monthly amount
- Social Assistance → variable amount based on household or income rules
- Child Allowance → per-child fixed rate

Amounts must be configurable in the Admin Settings.

---

# 6. Batch Approval Workflow

1. **Finance Officer creates batch** → status: `draft`
2. System generates `payment_items`
3. Finance officer reviews → status: `pending_approval`
4. Supervisor or Department Head approves → status: `approved`
5. System now allows export

Approval requires:
- Role: `finance_officer` or above (to create)
- Role: `department_head` or `system_admin` (to approve)

---

# 7. Bank Export Process (v1 – File Based)

### Why file‑based first?
- Most Surinamese banks still use batch CSV/TXT formats
- Lower risk and easier to ensure correctness
- API integration can be added later

### 7.1 Export Content
Generated by Edge Function:
```
createPaymentExport(batchId)
```

Fields typically include:
- Bank account number
- Account holder name
- Payment amount
- Reference code
- Batch ID

Export is uploaded into Supabase Storage: `payments/exports/`

### 7.2 Post-Export Status
- Batch moves to `exported`
- Finance officer downloads file and uploads to bank portal

---

# 8. Bank Feedback Ingestion

After bank processes the file, they return:
- Processed list
- Failed list
- Bank reference numbers

Finance officer uploads the file to:
```
/payment-feedback
```

Edge Function parses and updates:
- `payment_items.status` → `paid` or `failed`
- `payment_items.bank_reference`
- Batch → `completed` if all items processed

All changes logged in `payment_audit_logs`.

---

# 9. Admin UI – Payments Module

New sidebar section:
```
Payments
│
├── Batches
│   ├── Create Batch
│   ├── Batch Overview
│   └── Batch Detail (Items, Status, Logs)
│
└── Bank Feedback
```

### 9.1 Batch Detail Page Must Include:
- Batch metadata
- Payment item table with filters
- Approval controls (Approve/Reject)
- Export button
- Audit log timeline

### 9.2 Payment Item Table:
Columns:
- Citizen name
- Service type
- Case ID
- Amount
- Bank account
- Status
- Bank reference

---

# 10. RLS & Security Rules

- Only finance officers, department heads, and system admins may access payments module
- Citizens must never see payment information
- Payment amounts + bank accounts are classified as **Highly Sensitive Data**
- Exports must be pre‑signed URLs valid for short durations

---

# 11. Error Handling & UX Expectations

- If bank account missing → show warning during item generation
- If batch approval fails → show reason to finance officer
- If export cannot be generated → allow retry + log error
- If feedback upload contains unknown records → mark with `failed` + audit log entry

---

# 12. Completion Criteria for Phase 12

Phase 12 is complete when:

### Core:
- [ ] Payment generator engine creates correct batches
- [ ] Batch workflow implemented (draft → approved → exported → completed)
- [ ] Bank export files generated correctly

### UI:
- [ ] Payments module visible only to authorized roles
- [ ] Batch overview and detail pages functional
- [ ] Bank feedback ingestion UI implemented

### Security:
- [ ] RLS restricts all payment access
- [ ] Bank files protected via secure storage and temporary URLs
- [ ] All payment operations logged in `payment_audit_logs`

After completion, Lovable MUST await explicit approval for Phase 13 (Financial Reporting & Disbursement Forecasts – optional future phase).

---

**END OF PHASE 12 PLAN – PAYMENTS & DISBURSEMENT INTEGRATION (ENGLISH)**

